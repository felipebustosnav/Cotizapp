import React, { useState, useEffect } from 'react';
import { useNavigate, useParams, useLocation } from 'react-router-dom';
import { useForm, useFieldArray, Controller } from 'react-hook-form';
import { FiSave, FiArrowLeft, FiPlus, FiTrash2, FiCheck, FiX, FiInfo } from 'react-icons/fi';
import Select from 'react-select'; // Importar React Select
import quotationsService from '../../services/quotations.service';
import clientsService from '../../services/clients.service';
import productsService from '../../services/products.service';

const QuotationForm = () => {
    const { id } = useParams();
    const navigate = useNavigate();
    const location = useLocation();
    const isEditing = !!id;

    // Check if we are in approval mode
    const queryParams = new URLSearchParams(location.search);
    const isApprovalMode = queryParams.get('mode') === 'approval';

    const [loading, setLoading] = useState(false);
    const [clients, setClients] = useState([]);
    const [products, setProducts] = useState([]);
    const [error, setError] = useState('');

    const { register, control, handleSubmit, watch, setValue, reset, formState: { errors } } = useForm({
        defaultValues: {
            cliente: null, // Cambiado a objecto o null para react-select
            fecha_vencimiento: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 15 días por defecto
            estado: 'BORRADOR',
            notas: '',
            canal_preferencia: 'EMAIL',
            detalles: [{ producto_id: null, cantidad: 1, precio_unitario: 0, impuesto: 19 }]
        }
    });

    const { fields, append, remove } = useFieldArray({
        control,
        name: "detalles"
    });

    // Watchers para cálculos en tiempo real
    const detallesWatch = watch('detalles');
    const [totals, setTotals] = useState({ neto: 0, iva: 0, total: 0 });

    useEffect(() => {
        loadDependencies();
    }, []);

    useEffect(() => {
        if (isEditing && clients.length > 0 && products.length > 0) {
            loadQuotation();
        }
    }, [id, clients, products]);

    // Calcular totales cuando cambian los detalles
    useEffect(() => {
        calculateTotals(detallesWatch);
    }, [JSON.stringify(detallesWatch)]);

    const loadDependencies = async () => {
        try {
            setLoading(true);
            const [clientsData, productsData] = await Promise.all([
                clientsService.getAll(),
                productsService.getAll()
            ]);

            // Asegurar que sean arrays
            const receivedClients = Array.isArray(clientsData) ? clientsData : (clientsData.results || []);
            const receivedProducts = Array.isArray(productsData) ? productsData : (productsData.results || []);

            setClients(receivedClients);
            setProducts(receivedProducts);
        } catch (err) {
            console.error('Error loading dependencies:', err);
            setError('Error al cargar clientes o productos');
        } finally {
            if (!isEditing) setLoading(false);
        }
    };

    const [quotationData, setQuotationData] = useState(null);

    const loadQuotation = async () => {
        try {
            setLoading(true);
            const quotation = await quotationsService.getById(id);
            setQuotationData(quotation);

            // Preparar cliente para Select
            const clientObj = clients.find(c => c.id === (quotation.cliente?.id || quotation.cliente));
            const selectedClient = clientObj ? {
                value: clientObj.id,
                label: `${clientObj.nombre} ${clientObj.rut ? `(${clientObj.rut})` : ''}`
                        producto_id: prodObj ? {
                    value: prodObj.id,
                    label: `${prodObj.nombre} (${formatCurrency(prodObj.precio)})`,
                    price: prodObj.precio,
                    tax: prodObj.impuesto
                } : null,
                cantidad: d.cantidad,
                precio_unitario: d.precio_unitario,
                impuesto: d.impuesto
            };
        })
    };

    reset(formData);
} catch (err) {
    console.error('Error loading quotation:', err);
    setError('Error al cargar la cotización');
} finally {
    setLoading(false);
}
    };

const calculateTotals = (items) => {
    if (!items) return;

    let neto = 0;
    let iva = 0;

    items.forEach(item => {
        const cantidad = parseFloat(item.cantidad) || 0;
        const precio = parseFloat(item.precio_unitario) || 0;
        const impuesto = parseFloat(item.impuesto) || 0;

        const subtotal = cantidad * precio;
        neto += subtotal;
        iva += subtotal * (impuesto / 100);
    });

    setTotals({
        neto,
        iva,
        total: neto + iva
    });
};

const handleProductChange = (index, selectedOption) => {
    if (selectedOption) {
        setValue(`detalles.${index}.precio_unitario`, selectedOption.price);
        setValue(`detalles.${index}.impuesto`, selectedOption.tax);
    } else {
        // Optional: reset values if cleared
        setValue(`detalles.${index}.precio_unitario`, 0);
        setValue(`detalles.${index}.impuesto`, 19);
    }
};

const onSubmit = async (data) => {
    setLoading(true);
    setError('');

    // Preparar payload
    const payload = {
        cliente: data.cliente?.value, // Extraer ID del objeto Select
        fecha_vencimiento: data.fecha_vencimiento,
        estado: data.estado,
        notas: data.notas,
        canal_preferencia: data.canal_preferencia,
        detalles: data.detalles.map(d => ({
            producto: d.producto_id?.value, // Extraer ID del objeto Select
            cantidad: d.cantidad,
            precio_unitario: d.precio_unitario,
            impuesto: d.impuesto
        }))
    };

    try {
        // Validaciones adicionales antes de guardar
        if (!payload.cliente) {
            setError('Seleccione un cliente.');
            setLoading(false);
            return;
        }

        const selectedClient = clients.find(c => c.id === parseInt(payload.cliente));

        // Validar RUT obligatorio
        if (!selectedClient?.rut) {
            setError('El cliente seleccionado NO tiene RUT registrado. Actualice el cliente antes de generar la cotización.');
            setLoading(false);
            return;
        }

        // Validar Teléfono para WhatsApp
        if (data.canal_preferencia === 'WHATSAPP' && (!selectedClient?.telefono || selectedClient.telefono.length < 8)) {
            setError('El cliente seleccionado NO tiene un teléfono válido para WhatsApp. Actualice el cliente o cambie el canal.');
            setLoading(false);
            return;
        }

        // Validar productos vacíos
        if (payload.detalles.some(d => !d.producto)) {
            setError('Todos los items deben tener un producto seleccionado.');
            setLoading(false);
            return;
        }

        if (isEditing) {
            await quotationsService.update(id, payload);
        } else {
            await quotationsService.create(payload);
        }
        navigate('/cotizaciones');
    } catch (err) {
        console.error('Error saving quotation:', err);
        setError('Error al guardar la cotización. Verifique los campos.');
    } finally {
        setLoading(false);
    }
};

const onError = (errors) => {
    console.error("Form validation errors:", errors);
};

const handleApprove = async () => {
    if (!window.confirm('¿Estás seguro de aprobar esta cotización? Pasará a estado ENVIADA.')) return;

    try {
        setLoading(true);
        const res = await quotationsService.approve(id);
        alert(res.message);

        if (res.whatsapp_link) {
            window.open(res.whatsapp_link, '_blank');
        }

        navigate('/cotizaciones');
    } catch (err) {
        console.error('Error approving:', err);
        setError('Error al aprobar la cotización.');
    } finally {
        setLoading(false);
    }
};

const handleReject = async () => {
    if (!window.confirm('¿Rechazar esta cotización?')) return;

    try {
        setLoading(true);
        await quotationsService.reject(id);
        alert('Cotización rechazada correctamente');
        navigate('/cotizaciones');
    } catch (err) {
        console.error('Error rejecting:', err);
        setError('Error al rechazar la cotización.');
    } finally {
        setLoading(false);
    }
};

const formatCurrency = (val) => {
    return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(val);
};

// Prepare options for Select
const clientOptions = clients.map(c => ({
    value: c.id,
    label: `${c.nombre} ${c.rut ? `(${c.rut})` : ''}`
}));

const productOptions = products
    .filter(p => p.activo)
    .map(p => ({
        value: p.id,
        label: `${p.nombre} (${formatCurrency(p.precio)})`,
        price: p.precio,
        tax: p.impuesto_total || 0
    }));

// Custom styles for React Select to match design
const customStyles = {
    control: (provided, state) => ({
        ...provided,
        borderRadius: '8px',
        borderColor: state.isFocused ? 'var(--primary-orange)' : 'var(--gray-300)',
        boxShadow: state.isFocused ? '0 0 0 2px rgba(255, 107, 53, 0.2)' : 'none',
        padding: '2px',
        '&:hover': {
            borderColor: 'var(--primary-orange)'
        }
    }),
    option: (provided, state) => ({
        ...provided,
        backgroundColor: state.isSelected
            ? 'var(--primary-orange)'
            : state.isFocused
                ? 'var(--orange-light)'
                : 'white',
        color: state.isSelected ? 'white' : 'var(--text-dark)',
        cursor: 'pointer'
    })
};

if (loading && (!clients.length || !products.length)) {
    return <div className="loading-overlay"><div className="spinner"></div></div>;
}

return (
    <div className="container-custom">
        <div className="card-header-custom" style={{ marginTop: '20px', borderBottom: 'none' }}>
            <div>
                <h2>{isEditing ? (isApprovalMode ? 'Revisar Cotización' : 'Editar Cotización') : 'Nueva Cotización'}</h2>
                {watch('canal_preferencia') === 'WHATSAPP' && (
                    <div style={{ marginTop: '10px', fontSize: '13px', color: 'var(--blue-600)', display: 'flex', alignItems: 'center', gap: '5px' }}>
                        <FiInfo /> Verificar que el cliente tenga un teléfono válido (+569...)
                    </div>
                )}
                <p className="text-muted">
                    Detalla los productos y servicios para tu cliente
                </p>
            </div>
            <div style={{ display: 'flex', gap: '10px' }}>

                {isEditing && isApprovalMode && quotationData?.estado === 'BORRADOR' && (
                    <>
                        <button
                            className="btn-custom btn-success"
                            onClick={handleApprove}
                            disabled={loading}
                        >
                            <FiCheck size={20} /> Aprobar Cotización
                        </button>
                        <button
                            className="btn-custom btn-danger"
                            onClick={handleReject}
                            disabled={loading}
                            style={{ backgroundColor: 'var(--danger-red)', borderColor: 'var(--danger-red)', color: 'white' }}
                        >
                            <FiX size={20} /> Rechazar
                        </button>
                    </>
                )}

                <button className="btn-custom btn-secondary" onClick={() => navigate('/cotizaciones')}>
                    <FiArrowLeft size={20} /> Volver
                </button>
            </div>
        </div>

        <form onSubmit={handleSubmit(onSubmit, onError)} className="card-custom">
            {error && <div className="alert-custom alert-danger" style={{ marginBottom: '20px' }}>{error}</div>}

            {/* --- Encabezado --- */}
            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '20px', marginBottom: '30px' }}>

                <div className="form-group-custom">
                    <label className="form-label-custom">Cliente *</label>
                    <Controller
                        name="cliente"
                        control={control}
                        rules={{ required: 'Selecciona un cliente' }}
                        render={({ field }) => (
                            <Select
                                {...field}
                                options={clientOptions}
                                placeholder="Buscar cliente..."
                                styles={customStyles}
                                isDisabled={isApprovalMode}
                                isClearable
                            />
                        )}
                    />
                    {errors.cliente && <span className="form-error">{errors.cliente.message}</span>}
                </div>

                <div className="form-group-custom">
                    <label className="form-label-custom">Fecha de Validez *</label>
                    <input
                        type="date"
                        {...register('fecha_validez', { required: true })}
                        className="form-control-custom"
                        disabled={isApprovalMode}
                    />
                </div>

                <div className="form-group-custom">
                    <label className="form-label-custom">Estado</label>
                    <select {...register('estado')} className="form-control-custom" disabled={true}>
                        <option value="BORRADOR">Borrador</option>
                        <option value="ENVIADA">Enviada</option>
                        <option value="ACEPTADA">Aceptada</option>
                        <option value="RECHAZADA">Rechazada</option>
                    </select>
                </div>

                <div className="form-group-custom">
                    <label className="form-label-custom">Canal Preferencia</label>
                    <div style={{ display: 'flex', gap: '15px', marginTop: '8px' }}>
                        <label style={{ display: 'flex', alignItems: 'center', gap: '5px', cursor: 'pointer' }}>
                            <input
                                type="radio"
                                value="EMAIL"
                                {...register('canal_preferencia')}
                                disabled={isApprovalMode}
                            /> Email
                        </label>
                        <label style={{ display: 'flex', alignItems: 'center', gap: '5px', cursor: 'pointer' }}>
                            <input
                                type="radio"
                                value="WHATSAPP"
                                {...register('canal_preferencia')}
                                disabled={isApprovalMode}
                            /> WhatsApp
                        </label>
                    </div>
                </div>
            </div>

            {/* --- Detalles (Productos) --- */}
            <div style={{ marginBottom: '30px' }}>
                <h4 style={{ borderBottom: '1px solid var(--gray-200)', paddingBottom: '10px' }}>Items</h4>

                <table className="table-custom" style={{ marginTop: '10px' }}>
                    <thead>
                        <tr>
                            <th style={{ width: '40%' }}>Producto / Servicio</th>
                            <th style={{ width: '15%' }}>Precio Unit.</th>
                            <th style={{ width: '10%' }}>Cant.</th>
                            <th style={{ width: '15%' }}>Impuesto %</th>
                            <th style={{ width: '15%' }}>Total</th>
                            <th style={{ width: '5%' }}></th>
                        </tr>
                    </thead>
                    <tbody>
                        {fields.map((field, index) => {
                            // Safe parsing for calculations
                            const precio = parseFloat(watch(`detalles.${index}.precio_unitario`) || 0);
                            const cantidad = parseFloat(watch(`detalles.${index}.cantidad`) || 0);
                            const impuesto = parseFloat(watch(`detalles.${index}.impuesto`) || 0); // Default to 0 if NaN

                            const subtotal = precio * cantidad;
                            // If you want to show total line WITH tax:
                            const totalLinea = subtotal * (1 + (impuesto / 100));

                            return (
                                <tr key={field.id}>
                                    <td>
                                        <Controller
                                            name={`detalles.${index}.producto_id`}
                                            control={control}
                                            rules={{ required: true }}
                                            render={({ field: { onChange, value, ref } }) => (
                                                <Select
                                                    ref={ref}
                                                    options={productOptions}
                                                    value={value}
                                                    onChange={(val) => {
                                                        onChange(val);
                                                        handleProductChange(index, val);
                                                    }}
                                                    placeholder="Buscar producto..."
                                                    styles={customStyles}
                                                    isDisabled={isApprovalMode}
                                                    isClearable
                                                />
                                            )}
                                        />
                                    </td>
                                    <td>
                                        <div style={{ position: 'relative' }}>
                                            <span style={{ position: 'absolute', left: '8px', top: '10px', fontSize: '12px' }}>$</span>
                                            <input
                                                type="number"
                                                {...register(`detalles.${index}.precio_unitario`)}
                                                className="form-control-custom"
                                                style={{ paddingLeft: '20px', paddingRight: '5px' }}
                                                disabled={isApprovalMode}
                                            />
                                        </div>
                                    </td>
                                    <td>
                                        <input
                                            type="number"
                                            min="1"
                                            {...register(`detalles.${index}.cantidad`)}
                                            className="form-control-custom"
                                            style={{ textAlign: 'center' }}
                                            disabled={isApprovalMode}
                                        />
                                    </td>
                                    <td>
                                        <input
                                            type="number"
                                            {...register(`detalles.${index}.impuesto`)}
                                            className="form-control-custom"
                                            readOnly
                                            style={{ backgroundColor: 'var(--gray-100)', textAlign: 'center' }}
                                        />
                                    </td>
                                    <td style={{ fontWeight: 'bold', textAlign: 'right' }}>
                                        {formatCurrency(totalLinea)}
                                    </td>
                                    <td style={{ textAlign: 'center' }}>
                                        {!isApprovalMode && (
                                            <button
                                                type="button"
                                                onClick={() => remove(index)}
                                                className="btn-icon"
                                                style={{ color: 'var(--danger-red)', border: 'none', background: 'none', cursor: 'pointer' }}
                                            >
                                                <FiTrash2 size={18} />
                                            </button>
                                        )}
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>

                {!isApprovalMode && (
                    <button
                        type="button"
                        className="btn-custom btn-secondary btn-sm"
                        style={{ marginTop: '15px' }}
                        onClick={() => append({ producto_id: null, cantidad: 1, precio_unitario: 0, impuesto: 19 })}
                    >
                        <FiPlus size={16} /> Agregar Item
                    </button>
                )}
            </div>

            {/* --- Totales --- */}
            <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: '30px' }}>
                <div style={{ width: '300px', backgroundColor: 'var(--gray-50)', padding: '20px', borderRadius: '12px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                        <span>Subtotal Neto:</span>
                        <strong>{formatCurrency(totals.neto)}</strong>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '10px' }}>
                        <span>Impuesto (IVA):</span>
                        <strong>{formatCurrency(totals.iva)}</strong>
                    </div>
                    <div style={{ display: 'flex', justifyContent: 'space-between', borderTop: '2px solid var(--gray-300)', paddingTop: '10px', fontSize: '1.2em' }}>
                        <span>TOTAL:</span>
                        <strong style={{ color: 'var(--primary-orange)' }}>{formatCurrency(totals.total)}</strong>
                    </div>
                </div>
            </div>

            {/* --- Notas --- */}
            <div className="form-group-custom">
                <label className="form-label-custom">Notas Adicionales</label>
                <textarea
                    {...register('notas')}
                    className="form-control-custom"
                    rows="3"
                    placeholder="Términos, condiciones, comentarios..."
                    disabled={isApprovalMode}
                />
            </div>

            {/* --- Botones --- */}
            {!isApprovalMode && (
                <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '15px', marginTop: '30px', paddingTop: '20px', borderTop: '1px solid var(--gray-200)' }}>
                    <button type="button" className="btn-custom btn-secondary" onClick={() => navigate('/cotizaciones')}>
                        Cancelar
                    </button>
                    <button type="submit" className="btn-custom btn-primary" disabled={loading}>
                        <FiSave size={20} />
                        {loading ? 'Enviando...' : 'Enviar Cotización'}
                    </button>
                </div>
            )}
        </form>
    </div>
);
};

export default QuotationForm;
